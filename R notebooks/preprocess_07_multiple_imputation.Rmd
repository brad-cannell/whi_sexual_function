---
title: "Preprocess 07: Multiple Imputation"
date: "`r Sys.Date()`"
output: 
  github_document: default
---

```{r load_packages, message=FALSE}
# Load packages
library(tidyverse)
library(data.table)
library(mice)
library(lubridate)

# Load functions
source("../R scripts/functions.R")
```

-------------------------------------------------------------------------------

# Multiple Imputation

-------------------------------------------------------------------------------

```{r load_baseline_only}
# Load data
baseline_only <- read_rds("../data/baseline_only.rds")
check_data(baseline_only) # 83,145 observations and 34 variables
```

```{r}
count_ids(baseline_only$id) # 83,145 unique women
```

```{r}
dt <- as.data.table(baseline_only)
```
&nbsp;

Currently, the data includes information from 83,218 unique women. All women reported sexual activity in the past year. Additionally, each woman's abuse status can be determined.

## View the number and percent missing for each variable

```{r mice_dry_run}
ini <- mice(dt, maxit = 0)
```

```{r number_missing}
ini$nmis[order(ini$nmis)]
```
&nbsp;

```{r percent_missing}
(ini$nmis[order(ini$nmis)] / nrow(dt) * 100) %>% round(1)
```
&nbsp;

BMI, SSRI, chronic disease, caffeine, and hormone now all have a lot of missing.

## Preparing data for multiple imputation

```{r load_analysis_10_again}
analysis_10 <- read_rds("../data/analysis_10.rds")

# Drop satfrqsx_f - only needed for table 3.
analysis_10 <- analysis_10 %>% select(-satfrqsx_f)

check_data(analysis_10) # 743,094 observations and 34 variables
```

```{r}
dt <- as.data.table(analysis_10)
```

## Create next closet non-missing value variables

For BMI, SSRI, chronic disease, caffeine, and hormone now, create a second variable that contains the value at the next non-missing observation. I also, need to create a variable that captures the difference in days between observations.

After capturing the longitudinal information in the new variables, I will subset baseline again and perform multiple imputation.

Finally, the newly created variables will be dropped from the data before analysis.

To find the closest measure to baseline, we need to calculate the absolute difference in days between baseline and the day each measure occurred.

```{r create_diff_days}
dt[baseline == 1, baseline_days := days]
dt[, baseline_days := na.omit(baseline_days)[1], by = id]
dt[, diff_days := abs(days - baseline_days)]
```

```{r create_longitudinal_impute_values}
# Select variables
imp_vars <- select(dt, bmi, ssri_f, chronic_disease_f, f60caff, hormnw_f) %>% names()

# Get next closest missing values
dt <- get_imp_value(df = dt, imp_vars = imp_vars)

# Check results
# select(dt2, id, days, baseline, diff_days, chronic_disease_f, chronic_disease_f_2, chronic_disease_f_days)
check_data(dt) # 743,094 observations and 46 variables
```

## Subset baseline observations only

```{r}
dt <- dt[baseline == 1]
check_data(dt) # 83,145 observations and 46 variables
```

```{r}
# Clean up
rm(imp_vars)
dt[, c("baseline", "baseline_days", "diff_days") := NULL]
check_data(dt) # 83,145 observations and 43 variables
```

## View prop observed and influx / outflux

* pobs = proportion observed   
* influx = ranges from 0 to 1. For two variables with the same proportion of missing data, the variable with higher influx is better connected to the observed data, and might thus be easier to impute.   
* outflux = ranges from 0 to 1. For two variables with the same proportion of missing data, the variable with higher outflux is better connected to the missing data, and thus potentially more useful for imputing other variables.

```{r influx_outflux}
fluxplot(dt)
```
&nbsp;

We should also scrutinize the variables at the other end. Variables with high proportions of missing data generally create more problems than they solve. Unless some of these variables are of genuine interest to the investigator, it is best to leave them out. Virtually every dataset contains some parts that could better be removed before imputation. This includes, but is not limited to, uninteresting variables with a high proportion of missing data, variables without a code for the missing data, administrative variables, constant variables, duplicated, recoded or standardized variables, and aggregates and indices of other information.

van Buuren, Stef (2012-05-14). Flexible Imputation of Missing Data (Chapman & Hall/CRC Interdisciplinary Statistics) (Page 175). Taylor and Francis CRC ebook account. Kindle Edition. 

## Adjust multiple imputation settings

### View logged events

```{r logged_events}
ini <- mice(dt, m = 0, maxit = 0) # Dry run to view information about the imputation process
ini$loggedEvents
```
&nbsp;

Makes sense. Everyone included in the data at this point said yes to sexactiv_f. What is chronic_disease_f colinear with?

```{r}
dt %>% 
  mutate(
    chronic_disease_f   = if_else(is.na(chronic_disease_f), 9, as.numeric(chronic_disease_f)),
    chronic_disease_f_2 = if_else(is.na(chronic_disease_f_2), 9, as.numeric(chronic_disease_f_2))
  ) %>% 
  summarise(
    `Count Same` = sum(chronic_disease_f == chronic_disease_f_2),
    `Count Diff` = sum(chronic_disease_f != chronic_disease_f_2)
  )
```

View the current imputation process information

```{r}
ini
```
&nbsp;

### Adjust prediction matrix   

* Make sure administrative variables are being used for imputation (e.g. id, ctos)      
* Make sure var_days variables aren't imputing anything other than their specific var. For example, bmi_days should only be used to impute bmi, not marital status.     
* Adjust any other variables that appear to be noise.   

The _rows_ of the predictor matrix correspond to the variables being predicted (or not). The _columns_ of the predictor matrix correspond to the variables being used to predict.

```{r prediction_matrix}
# Copy the predictor matrix to a new object
pred <- ini$predictorMatrix 

# Set cells of the matrix to 0 or 1 as needed, using index [r, c] notation
# All completely observed vars (e.g., age) are not predicted by default (i.e., row of 0's)
pred[, c("id", "age_group_f", "ctos_f")] <- 0 # Don't use these to impute anything

# Adjust imputation for var_days (see description above)
pred[, c("bmi_days", "ssri_f_days", "chronic_disease_f_days", "f60caff_days", "hormnw_f_days")] <- 0
pred["bmi", "bmi_days"]                             <- 1
pred["ssri_f", "ssri_f_days"]                       <- 1
# pred["chronic_disease_f", "chronic_disease_f_days"] <- 1 # Removed for collinearity
pred["f60caff", "f60caff_days"]                     <- 1
pred["hormnw_f", "hormnw_f_days"]                   <- 1
```

### Adjust MI methods

* To prevent vars from being imputed, we need to set the method to missing in addition to adjusting the predictor matrix.   
* In this case, everything looks good.   

```{r}
meth <- ini$method
meth
```

## Generate the imputations

```{r create_mi}
start <- now()

imp <- mice(data = dt,
            m = 5,                      # Default - adding for explicitivity
            method = meth,              # Custom method vector created above
            predictorMatrix = pred,     # Custom predictor matrix created above
            seed = 20170511)            # For reproducability

stop <- now()
time <- difftime(stop, start)
```

```{r}
time # MI took 3.36 hours to run
```

# Save the imputed data

```{r}
write_rds(imp, path = "../data/imp.rds")
```

```{r session_info, echo=FALSE}
sessionInfo()
```
