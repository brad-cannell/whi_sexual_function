---
title: "Preprocess 03: Create Final Analysis Data"
date: "`r Sys.Date()`"
output: 
  html_notebook:
    toc: true
  html_document:
    toc: true
    toc_float: true
    code_folding: show
    # css: custom-css.css
  word_document:
    reference_docx: word_style_template_01.docx
---

```{r load_packages, message=FALSE}
# Load packages
library(tidyverse)
library(data.table)
library(mice)
library(lubridate)

# Load functions
source("../R scripts/functions.R")
```

* Primary exposure of interest:     
    + Abuse (Yes / NO)     
    + Abuse (4-level)   
    
* Sexual activity in past year is another exposure of special interest. We are only interested in the association between abuse and sexual function among women that were sexually active.
    
* Outcomes of interest:   
    + Sexual satisfaction   
    + Sexual frequency satisfaction
    
* Covariates of interest:   
    + Age    
    + Race / ethnicity    
    + Education   
    + Income   
    + Marital status    
    + Sexual orientation    
    + Study component     
    + Parity    
    + Physical activity    
    + Alcohol use     
    + Caffeine use    
    + Smoking    
    + Hormone use    
    + Taking SSRIs    
    + Quality of life   
    + Depression    
    + BMI    
    + General health    
    + Hysterectomy    
    + Night sweats    
    + Hot flashes    
    + Vaginal dryness    
    + Urinary incontinence    
    + Chronic disease

* The first set of analyses will be cross-sectional, and use only baseline measures

Currently, all 161,808 women are still represented in the data.

```{r load_analysis_09}
# Load data
analysis_09 <- read_rds("../data/analysis_09.rds")
check_data(analysis_09) # 1,432,448 observations and 127 variables
```

```{r}
dt <- as.data.table(analysis_09)
```

# Tag baseline observations

Baseline is either each woman's first response to an abuse question or day 0 if she never responded to either abuse question.

```{r tag_baseline}
dt[first_ab_obs == TRUE, baseline := TRUE]
dt[abuse_ever == -3 & days == 0, baseline := TRUE]
```

# Subset the variables of interest

```{r subset_vars_of_interest}
dt <- dt[, .(id, days, abuse_d_f, abuse4cat_f, sexactiv_f, satisfied_f, freq_satisfied_f, satfrqsx_f, age,
             age_group_f, race_eth_f, edu4cat_f, inc5cat_f, married_f, sex_f, ctos_f, parity_f, texpwk, alcswk,
             f60caff, smoking_f, horm_f, hormnw_f, ssri_f, lifequal, pshtdep, bmi, good_health_f, hyst_f,
             night_sweats_f, hot_flashes_f, vag_dry_f, incont_f, chronic_disease_f, baseline)]
check_data(dt) # 1,432,448 observations and 35 variables
```









-------------------------------------------------------------------------------

# Missing sexual activity

-------------------------------------------------------------------------------

Sexual activity in the past year is not being used for modeling. Rather, we will drop women that were not sexually active in the previous year. Multiple imputation is not prediction. And therefore, it would be inappropriate to try to somehow use MI to predict which women were sexually active in the past year, and retain their data for analysis.

> The main message is that we cannot evaluate imputation methods by their ability to re-create the true data, or by their ability to optimize classification accuracy. Imputation is not prediction.
van Buuren, Stef (2012-05-14). Flexible Imputation of Missing Data (Chapman & Hall/CRC Interdisciplinary Statistics) (Page 46). Taylor and Francis CRC ebook account. Kindle Edition. 

```{r sexactive_freq}
# What is the frequency distribution for sexually active at baseline?
dt[baseline == 1][order(sexactiv_f)][, .(Women = .N), by = sexactiv_f][, Cumsum := cumsum(Women)][
  , Percent := Women / max(Cumsum) * 100][]
```

```{r}
71239 + 7167 # 78,406 women have no or NA for sexactive_f at baseline.
```
&nbsp;

All rows for all 78,406 women that did not report being sexually active in the previous year will be dropped from the data.

```{r keep_sexactive}
# Gather id's with Yes for sexactiv_f at baseline.
keep_ids <- dt[baseline == 1 & sexactiv_f == "Yes", id]

# Keep rows for sexually active women
dt <- dt[id %in% keep_ids]
count_ids(dt$id) # 83,402 unique women
```
&nbsp;

How many women report "never having sex" on the sexual orientation question

```{r never_had_sex}
dt[, length(unique(id)), by = sex_f]
```

```{r drop_never_sex}
drop_ids <- dt[baseline == 1 & sex_f == "Have never had sex", id]
drop_ids <- which(dt$id %in% drop_ids)
dt <- dt[-drop_ids]
count_ids(dt$id) # 83,329 unique women
```

```{r}
check_data(dt) # 744,745 observations and 35 variables
```

```{r}
# Clean up
rm(keep_ids, drop_ids)
```









-------------------------------------------------------------------------------

# Missing abuse

-------------------------------------------------------------------------------

How many women are missing abuse (2-level) at baseline?

```{r abuse2cat_freq}
dt[baseline == 1][order(abuse_d_f)][, .(Women = .N), by = abuse_d_f][, Cumsum := cumsum(Women)][
  , Percent := Women / max(Cumsum) * 100][]
```

Of the 83,402 women that reported sexual activity in the past year, 2 never answered either abuse question and 158 women's abuse status could not be determined from their answers. The abuse status (2-level) can be determined for over 99% of the 83,402 women who reported sexual activity in the past year.

How many women are missing abuse (4-level) at baseline?

```{r abuse4cat_freq}
dt[baseline == 1][order(abuse4cat_f)][, .(Women = .N), by = abuse4cat_f][, Cumsum := cumsum(Women)][
  , Percent := Women / max(Cumsum) * 100][]
```

Of the 83,402 women that reported sexual activity in the past year, 2 never answered either abuse question and 182 women's abuse status could not be determined from their answers. The abuse status (4-level) can be determined for over 99% of the 83,402 women who reported sexual activity in the past year.

We will drop observations from the 182 women who's abuse status at baseline was missing or could not be determined from their responses.

```{r check_abuse2cat}
# Set alternate codings for missing to NA
dt[, abuse_d_f := if_else(abuse_d_f %in% c("No", "Yes"), abuse_d_f, NA_integer_)]
dt[baseline == 1][order(abuse_d_f)][, .(Women = .N), by = abuse_d_f][, Cumsum := cumsum(Women)][
  , Percent := Women / max(Cumsum) * 100][]
```

```{r check_abuse4cat}
# Set alternate codings for missing to NA
keep <- c("Physical and verbal abuse", "Physical abuse only", "Verbal abuse only", "Did not experience abuse")
dt[, abuse4cat_f := if_else(abuse4cat_f %in% keep, abuse4cat_f, NA_integer_)]
dt[baseline == 1][order(abuse4cat_f)][, .(Women = .N), by = abuse4cat_f][, Cumsum := cumsum(Women)][
  , Percent := Women / max(Cumsum) * 100][]
```

```{r keep_with_abuse}
# Gather id's without NA for abuse4cat_f at baseline.
ids <- dt[baseline == 1 & !is.na(abuse4cat_f), id]

# Keep rows with non-missing abuse4cat
dt <- dt[id %in% ids]
count_ids(dt$id) # 83,145 unique women
```

```{r}
83329 - 83145 # 184
```

184 women were dropped from the data because their abuse status (4-level) could not be determined.

```{r}
check_data(dt) # 743,094 observations and 35 variables
```

```{r}
# Clean up
rm(keep, ids)
```









-------------------------------------------------------------------------------

# Missing sexual satisfaction

-------------------------------------------------------------------------------

How many women are missing sexual satisfaction at baseline?

```{r satisfied_freq}
dt[baseline == 1][order(satisfied_f)][, .(Women = .N), by = satisfied_f][, Cumsum := cumsum(Women)][
  , Percent := Women / max(Cumsum) * 100][]
```
&nbsp;

How many women are missing sexual frequency satisfaction at baseline?

```{r freq_satisfied_freq}
dt[baseline == 1][order(freq_satisfied_f)][, .(Women = .N), by = freq_satisfied_f][, Cumsum := cumsum(Women)][
  , Percent := Women / max(Cumsum) * 100][]
```
&nbsp;

Only 4% of women are missing sexual satisfaction at baseline, and only 5% of women are missing sexual frequency satisfaction at baseline. At some point, we may want to come back and impute sexual satisfaction and sexual frequency satisfaction longitudinally. For now, we will impute them from other variables in the data set.

Save progress

```{r save_analysis_10}
analysis_10 <- as_tibble(dt)
write_rds(analysis_10, path = "../data/analysis_10.rds")
```










-------------------------------------------------------------------------------

# Create data subsets for Table 1 (prior to multiple imputation)

-------------------------------------------------------------------------------

```{r load_analysis_10}
# Load data
analysis_10 <- read_rds("../data/analysis_10.rds")
check_data(analysis_10) # 743,094 observations and 35 variables
```

```{r}
count_ids(analysis_10$id) # 83,145 unique women
```

```{r}
dt <- as.data.table(analysis_10)
```
&nbsp;

Currently, the data includes information from 83,218 unique women. All women reported sexual activity in the past year. Additionally, each woman's abuse status can be determined.

## Subset baseline observations only

```{r subset_baseline_only}
baseline_only <- dt %>% filter(baseline == TRUE)

# Drop the baseline variable
baseline_only$baseline <- NULL

check_data(baseline_only) # 83,145 observations and 34 variables
```

## Create subgroups for Table 1 (no, any, verbal only, phys only, both)

```{r subset_abuse_groups}
no_abuse            <- baseline_only %>% filter(abuse_d_f == "No")
any_abuse           <- baseline_only %>% filter(abuse_d_f == "Yes")
verbal_only         <- baseline_only %>% filter(abuse4cat_f == "Verbal abuse only")
physical_only       <- baseline_only %>% filter(abuse4cat_f == "Physical abuse only")
verbal_and_physical <- baseline_only %>% filter(abuse4cat_f == "Physical and verbal abuse")

# Count total observations
nrow(no_abuse) + nrow(verbal_only) + nrow(physical_only) + nrow(verbal_and_physical) # 83145
```

### Data check: group sizes

```{r data_check_group_sizes, echo=FALSE}
cat("No abuse:", nrow(no_abuse), "\n") # 73,759 
cat("Any abuse:", nrow(any_abuse), "\n") # 9,386
cat("No + Any:", nrow(no_abuse) + nrow(any_abuse), "\n") # 83,145 

cat("Verbal only:", nrow(verbal_only), "\n") # 8,374 
cat("Physical only:", nrow(physical_only), "\n") # 188
cat("Both:", nrow(verbal_and_physical), "\n") # 824
cat("Total:", nrow(no_abuse) + nrow(verbal_only) + nrow(physical_only) + nrow(verbal_and_physical), "\n") # 83,145
```

## Save subgroup data for Table 1

```{r save_subgroups_for_table_1}
write_rds(baseline_only, path = "../data/baseline_only.rds")
write_rds(no_abuse, path = "../data/no_abuse.rds")
write_rds(any_abuse, path = "../data/any_abuse.rds")
write_rds(verbal_only, path = "../data/verbal_only.rds")
write_rds(physical_only, path = "../data/physical_only.rds")
write_rds(verbal_and_physical, path = "../data/verbal_and_physical.rds")
```










-------------------------------------------------------------------------------

# Multiple Imputation

-------------------------------------------------------------------------------

```{r load_baseline_only}
# Load data
baseline_only <- read_rds("../data/baseline_only.rds")
check_data(baseline_only) # 83,218 observations and 34 variables
```

```{r}
count_ids(baseline_only$id) # 83,218 unique women
```

```{r}
dt <- as.data.table(baseline_only)
```
&nbsp;

Currently, the data includes information from 83,218 unique women. All women reported sexual activity in the past year. Additionally, each woman's abuse status can be determined.

## View the number and percent missing for each variable

```{r mice_dry_run}
ini <- mice(dt, maxit = 0)
```

```{r number_missing}
ini$nmis[order(ini$nmis)]
```
&nbsp;

```{r percent_missing}
(ini$nmis[order(ini$nmis)] / nrow(dt) * 100) %>% round(1)
```
&nbsp;

BMI, SSRI, chronic disease, caffeine, and hormone now all have a lot of missing.

## Preparing data for multiple imputation

```{r load_analysis_10_again}
analysis_10 <- read_rds("../data/analysis_10.rds")

# Drop satfrqsx_f - only needed for table 3.
analysis_10 <- analysis_10 %>% select(-satfrqsx_f)

check_data(analysis_10) # 743,756 observations and 34 variables
```

```{r}
dt <- as.data.table(analysis_10)
```

## Create next closet non-missing value variables

For BMI, SSRI, chronic disease, caffeine, and hormone now, create a second variable that contains the value at the next non-missing observation. I also, need to create a variable that captures the difference in days between observations.

After capturing the longitudinal information in the new variables, I will subset baseline again and perform multiple imputation.

Finally, the newly created variables will be dropped from the data before analysis.

To find the closest measure to baseline, we need to calculate the absolute difference in days between baseline and the day each measure occurred.

```{r create_diff_days}
dt[baseline == 1, baseline_days := days]
dt[, baseline_days := na.omit(baseline_days)[1], by = id]
dt[, diff_days := abs(days - baseline_days)]
```

```{r create_longitudinal_impute_values}
# Select variables
imp_vars <- select(dt, bmi, ssri_f, chronic_disease_f, f60caff, hormnw_f) %>% names()

# Get next closest missing values
dt <- get_imp_value(df = dt, imp_vars = imp_vars)

# Check results
# select(dt2, id, days, baseline, diff_days, chronic_disease_f, chronic_disease_f_2, chronic_disease_f_days)
check_data(dt) # 743,756 observations and 46 variables
```

## Subset baseline observations only

```{r}
dt <- dt[baseline == 1]
check_data(dt) # 83,218 observations and 46 variables
```

```{r}
# Clean up
rm(imp_vars)
dt[, c("baseline", "baseline_days", "diff_days") := NULL]
check_data(dt) # 83,218 observations and 43 variables
```

## View prop observed and influx / outflux

* pobs = proportion observed   
* influx = ranges from 0 to 1. For two variables with the same proportion of missing data, the variable with higher influx is better connected to the observed data, and might thus be easier to impute.   
* outflux = ranges from 0 to 1. For two variables with the same proportion of missing data, the variable with higher outflux is better connected to the missing data, and thus potentially more useful for imputing other variables.

```{r influx_outflux}
fluxplot(dt)
```
&nbsp;

We should also scrutinize the variables at the other end. Variables with high proportions of missing data generally create more problems than they solve. Unless some of these variables are of genuine interest to the investigator, it is best to leave them out. Virtually every dataset contains some parts that could better be removed before imputation. This includes, but is not limited to, uninteresting variables with a high proportion of missing data, variables without a code for the missing data, administrative variables, constant variables, duplicated, recoded or standardized variables, and aggregates and indices of other information.

van Buuren, Stef (2012-05-14). Flexible Imputation of Missing Data (Chapman & Hall/CRC Interdisciplinary Statistics) (Page 175). Taylor and Francis CRC ebook account. Kindle Edition. 

## Adjust multiple imputation settings

### View logged events

```{r logged_events}
ini <- mice(dt, m = 0, maxit = 0) # Dry run to view information about the imputation process
ini$loggedEvents
```
&nbsp;

Makes sense. Everyone included in the data at this point said yes to sexactiv_f. What is chronic_disease_f colinear with?

```{r}
dt %>% 
  mutate(
    chronic_disease_f   = if_else(is.na(chronic_disease_f), 9, as.numeric(chronic_disease_f)),
    chronic_disease_f_2 = if_else(is.na(chronic_disease_f_2), 9, as.numeric(chronic_disease_f_2))
  ) %>% 
  summarise(
    `Count Same` = sum(chronic_disease_f == chronic_disease_f_2),
    `Count Diff` = sum(chronic_disease_f != chronic_disease_f_2)
  )
```

View the current imputation process information

```{r}
ini
```
&nbsp;

### Adjust prediction matrix   

* Make sure administrative variables are being used for imputation (e.g. id, ctos)      
* Make sure var_days variables aren't imputing anything other than their specific var. For example, bmi_days should only be used to impute bmi, not marital status.     
* Adjust any other variables that appear to be noise.   

The _rows_ of the predictor matrix correspond to the variables being predicted (or not). The _columns_ of the predictor matrix correspond to the variables being used to predict.

```{r prediction_matrix}
# Copy the predictor matrix to a new object
pred <- ini$predictorMatrix 

# Set cells of the matrix to 0 or 1 as needed, using index [r, c] notation
# All completely observed vars (e.g., age) are not predicted by default (i.e., row of 0's)
pred[, c("id", "age_group_f", "ctos_f")] <- 0 # Don't use these to impute anything

# Adjust imputation for var_days (see description above)
pred[, c("bmi_days", "ssri_f_days", "chronic_disease_f_days", "f60caff_days", "hormnw_f_days")] <- 0
pred["bmi", "bmi_days"]                             <- 1
pred["ssri_f", "ssri_f_days"]                       <- 1
# pred["chronic_disease_f", "chronic_disease_f_days"] <- 1 # Removed for collinearity
pred["f60caff", "f60caff_days"]                     <- 1
pred["hormnw_f", "hormnw_f_days"]                   <- 1
```

### Adjust MI methods

* To prevent vars from being imputed, we need to set the method to missing in addition to adjusting the predictor matrix.   
* In this case, everything looks good.   

```{r}
meth <- ini$method
meth
```

## Generate the imputations

```{r create_mi}
start <- now()

imp <- mice(data = dt,
            m = 5,                      # Default - adding for explicitivity
            method = meth,              # Custom method vector created above
            predictorMatrix = pred,     # Custom predictor matrix created above
            seed = 20170511)            # For reproducability

stop <- now()
time <- difftime(stop, start)
```

```{r}
time # MI took 3.36 hours to run
```

# Save the imputed data

```{r}
write_rds(imp, path = "../data/imp.rds")
```

-------------------------------------------------------------------------------

&nbsp;

#### Session Info:

```{r session_info, echo=FALSE}
sessionInfo()
```
