---
title: "Preprocess 02: Variable Management"
date: "`r Sys.Date()`"
output: 
  html_notebook:
    toc: true
  html_document:
    toc: true
    toc_float: true
    code_folding: show
    # css: custom-css.css
  word_document:
    reference_docx: word_style_template_01.docx
---

```{r load_packages, message=FALSE}
# Load packages
library(tidyverse)
library(haven)
library(zoo)
library(data.table)
library(lubridate)
library(gmodels)
library(forcats)

# Load functions
source("../R scripts/functions.R")
```

-------------------------------------------------------------------------------

# Dichotomize medications to reduce duplicated days

-------------------------------------------------------------------------------

* Tccode creates a separate row within id and day for each medication taken. We only care about SSRI's. We will collapse into a single row within id and day with a single variable indicating if an SSRI was reported or not.

* Drug class from Erika (2017-03-09): 581600

```{r load_analysis_01}
# Load data
analysis_01 <- read_rds("../data/analysis_01.rds")
check_data(analysis_01) # 2,448,638 observations and 50 variables
```

```{r}
dt <- as.data.table(analysis_01)
```

## Tag observations with 581600 and distribute SSRI within id and days

```{r tag_ssri, rows.print=12}
# Create new var, SSRI, that is equal to 1 if any drug within id and day is an SSRI
dt[, ssri := if_else(any(tccode == "581600"), 1, 0, NA_real_), by = .(id, days)]
# select(dt, id, days, tccode, ssri) %>% filter(id == 100088)
check_data(dt) # 2,448,638 observations and 51 variables
```

## Now that SSRI is distributed within id and day, keep one row per day 

```{r one_row_per_ssri}
# Drop tccode
dt[, tccode := NULL]
check_data(dt) # 2,448,638 observations and 50 variables
```

```{r check_dups}
# Create new logical var, dup, that is TRUE when the row is a duplicate
dt[, dup := duplicated(dt)]
check_data(dt) # 2,448,638 observations and 51 variables
```

```{r}
# Count dup == TRUE
sum(dt$dup) # 1,016,190
```

```{r drop_dups}
# Drop duplicate rows
dt <- dt[dup == FALSE, ]
check_data(dt) # 1,432,448 observations and 50 variables
```

```{r check_dups_02}
# Any duplicates by id and days?
dt[, dup := duplicated(.SD), .SDcols = c("id", "days")]
dt[, sum(dup)] # 0
```

```{r drop_dups_02}
# Drop dup
dt$dup <- NULL
check_data(dt) # 1,432,448 observations and 50 variables
```

```{r save_analysis_02}
# Save progress
analysis_02 <- dt
write_rds(analysis_02, path = "../data/analysis_02.rds")
```

At this point there are 1,432,448 observations and 50 variables. There are no duplicate rows in terms of id and days.









-------------------------------------------------------------------------------

# Expand age across time

-------------------------------------------------------------------------------

```{r load_analysis_02}
# Load data
analysis_02 <- read_rds("../data/analysis_02.rds")
check_data(analysis_02) # 1,432,448 observations and 50 variables
```

```{r}
dt <- as.data.table(analysis_02)
```

```{r wrangle_age}
dt[, age_days := age * 365.25]
dt[, age_days_2 := na.omit(age_days)[1], by = id]
dt[, age_days_2 := age_days_2 + days]
dt[, age_2 := round(age_days_2 / 365.25)]
# select(dt, id, days, age, age_days, age_days_2, age_2)
dt[, age := age_2]
dt[, c("age_days", "age_days_2", "age_2") := NULL]
# select(dt, id, days, age)
dt[days == 0, .(.N, `Mean Age at Baseline` = mean(age), SD = sd(age), Min = min(age), Max = max(age))]
```

```{r save_analysis_03}
# Save progress
analysis_03 <- dt
write_rds(analysis_03, path = "../data/analysis_03.rds")
```









-------------------------------------------------------------------------------

# Create variables: obs, finalobs, finalage, numobs, finalyears

-------------------------------------------------------------------------------

```{r load_analysis_03}
# Load data
analysis_03 <- read_rds("../data/analysis_03.rds")
check_data(analysis_03) # 1,432,448 observations and 50 variables
```

```{r}
dt <- as.data.table(analysis_03)
```

## Creating a observation number variable

```{r create_obs}
dt <- dt[order(id, days), ]
dt[, obs := 1:.N, by = id]
# select(dt, id, days, obs)
dt[, .(`Mean Number of Observations Per Woman` = mean(obs), SD = sd(obs))]
```
			
## Creating an age at final observation tag

```{r tag_age_final_obs}
dt[, final_obs := if_else(obs == max(obs), TRUE, FALSE), by = id]
attributes(dt$final_obs)$label <- "Tag largest observation number by id"
# select(dt, id, days, obs, final_obs)
sum(dt$final_obs) # 161,808
```

## Creating age at final observation variable

```{r create_age_final_obs}
dt[final_obs == TRUE, final_age := age, by = id]
dt[final_obs == TRUE, .(.N, `Mean Age at Last Observation` = mean(final_age), SD = sd(final_age), 
                        Min = min(final_age), Max = max(final_age))]
```

## Distribute final age across observations

```{r dist_final_age}
dt[, final_age := max(final_age, na.rm = TRUE), by = id]
attributes(dt$final_age)$label <- "Age at final observation"
# select(dt, id, days, age, final_age)
```

## Creating number of observations variable at final observation

```{r create_n_obs_at_final_obs}
dt[final_obs == TRUE, num_obs := obs]
dt[final_obs == TRUE, .(.N, `Mean Observations per Woman` = mean(obs), SD = sd(obs), Min = min(obs), 
                        Max = max(obs))]
```

## Distribute num_obs across observations

```{r dist_num_obs}
dt[, num_obs := max(num_obs, na.rm = TRUE), by = id]
attributes(dt$numobs)$label <- "Number of observations"
# select(dt, id, days, obs, num_obs)
```

## Creating years since e/r at final observation variable

```{r create_years_since_enroll}
dt[, years := round(days / 365.25)]
dt[final_obs == TRUE, total_years := years]
dt[final_obs == TRUE, .(.N, `Mean Number of Years Enrolled` = mean(years), SD = sd(years), Min = min(years), 
                        Max = max(years))]
```

## Distribute total_years across observations

```{r dist_years_since_enroll}
dt[, total_years := max(total_years, na.rm = TRUE), by = id]
attributes(dt$finalyears)$label <- "Total years since e/r @ last observation"
# select(dt, id, days, final_obs, years, total_years)
```

```{r save_analysis_04}
# Save progress
analysis_04 <- dt
write_rds(analysis_04, path = "../data/analysis_04.rds")
```









------------------------------------------------------------------------------

# Clean primary exposure variable of interest: Abuse

-------------------------------------------------------------------------------

* [You were physically abused?](https://www.whi.org/researchers/data/WhiDataDict/f37_ctos_inv.pdf)

Below are some hard things that sometimes happen to people. Please try to think back over the past year to remember if any of these things happened. Mark the answer that seems best. Over the past year: Were you physically abused by being hit, slapped, pushed, shoved, punched or threatened with a weapon by a family member or close friend? 

* [You were verbally abused?](https://www.whi.org/researchers/data/WhiDataDict/f37_ctos_inv.pdf)

Below are some hard things that sometimes happen to people. Please try to think back over the past year to remember if any of these things happened. Mark the answer that seems best. Over the past year: . Were you verbally abused by being made fun of, severely criticized, told you were a stupid or worthless person, or threatened with harm to yourself, your possessions, or your pets, by a family member or close friend?

* [Possible responses:](https://www.whi.org/researchers/data/WhiDataDict/f37_ctos_inv.pdf)

0. No   
1. Yes and upset me: Not too much   
2. Yes and upset me: Moderately     
3. Yes and upset me: Very much     


## Create dichotomous abuse at current observation variables

```{r load_analysis_04}
# Load data
analysis_04 <- read_rds("../data/analysis_04.rds")
check_data(analysis_04) # 1,432,448 observations and 58 variables
```

```{r}
dt <- as.data.table(analysis_04)
```

### Create a dichotomous physical abuse (at current observation) variable

```{r}
dt[, phyab_d := if_else(is.na(phyab) & is.na(verbab),  -3, # Abuse not measured
                if_else(is.na(phyab) & !is.na(verbab), -1, # Unable to determine
                if_else(phyab == 0,                     0, # Did not experience physical abuse
                if_else(phyab > 0,                      1, # Experienced physical abuse
                NA_real_))))]

dt[, phyab_d_f := factor(phyab_d, labels = c("Abuse not measured", "Unable to determine", "No", "Yes"))]

attributes(dt$phyab_d)$label   <- "Any physical abuse in the current observation"
attributes(dt$phyab_d_f)$label <- "Any physical abuse in the current observation"

# select(dt, id, days, verbab, phyab, phyab_d, phyab_d_f)

CrossTable(dt$phyab_d_f)
# Abuse not measured:  1,059,536 observations
# Unable to determine: 423 observations
# No:                  368,783 observations
# Yes:                 3,706 observations
```

### Create a dichotomous verbal abuse variable

```{r}
dt[, verbab_d := if_else(is.na(verbab) & is.na(phyab),  -3, # Abuse not measured
                 if_else(is.na(verbab) & !is.na(phyab), -1, # Unable to determine
                 if_else(verbab == 0,                    0, # Did not experience verbal abuse
                 if_else(verbab > 0,                     1, # Experienced verbal abuse
                 NA_real_))))]

dt[, verbab_d_f := factor(verbab_d, labels = c("Abuse not measured", "Unable to determine", "No", "Yes"))]

attributes(dt$verbab_d)$label   <- "Any verbal abuse in the current observation"
attributes(dt$verbab_d_f)$label <- "Any verbal abuse in the current observation"

# select(dt, id, days, verbab, phyab, verbab_d, verbab_d_f)

CrossTable(dt$verbab_d_f)
# Abuse not measured:  1,059,536 observations
# Unable to determine: 752 observations
# No:                  337,497 observations
# Yes:                 34,663 observations
```

### Create a dichotomous any abuse variable

```{r}
dt[, abuse_d := if_else(phyab_d == 1 | verbab_d == 1,   1, # Experienced abuse
                if_else(phyab_d == 0 & verbab_d == 0,   0, # Did not experience abuse
                if_else(is.na(phyab) & !is.na(verbab), -1, # Can't determine, answered verbab, but not phyab
                if_else(is.na(verbab) & !is.na(phyab), -2, # Can't determine, answered phyab, but not verbab
                if_else(is.na(phyab) & is.na(verbab),  -3, # Abuse not measured
                NA_real_)))))]

dt[, abuse_d_f := factor(abuse_d, labels = c("Abuse not measured", "Answered phyab, but not verbab",
                                             "Answered verbab, but not phyab", "No", "Yes"))]

attributes(dt$abuse_d)$label   <- "Was either type of abuse observed in the current observation"
attributes(dt$abuse_d_f)$label <- "Was either type of abuse observed in the current observation"

# select(dt, id, days, phyab, verbab, phyab_d, verbab_d, abuse_d, abuse_d_f) %>% filter(abuse_d == 1)

CrossTable(dt$abuse_d)
# Abuse not measured:                              1,059,536 observations
# Can't determine, answered phyab, but not verbab: 727 observations
# Can't determine, answered phyab, but not verbab: 337 observations
# No:                                              336,385 observations
# Yes:                                             35,463 observations
```

## Create 4-level abuse at current observation variable

```{r}
dt[, abuse4cat := if_else(phyab_d == 1 & verbab_d == 1,   3, # Experienced physical and verbal abuse
                  if_else(phyab_d == 1 & verbab_d == 0,   2, # Experienced physical abuse only
                  if_else(phyab_d == 0 & verbab_d == 1,   1, # Experienced verbal abuse only
                  if_else(phyab_d == 0 & verbab_d == 0,   0, # Did not experience abuse
                  if_else(is.na(phyab) & !is.na(verbab), -1, # Can't determine, answered verbab, but not phyab
                  if_else(is.na(verbab) & !is.na(phyab), -2, # Can't determine, answered phyab, but not verbab
                  if_else(is.na(phyab) & is.na(verbab),  -3, # Abuse not measured
                  NA_real_)))))))]

dt[, abuse4cat_f := factor(abuse4cat, levels = c(3, 2, 1, 0, -1, -2, -3), 
                           labels = c("Physical and verbal abuse", "Physical abuse only", "Verbal abuse only",
                                      "Did not experience abuse", "Can't determine V no P", 
                                      "Can't determine P no V", "Abuse not measured"))]

attributes(dt$abuse4cat)$label   <- "4-level abuse category observed in the current observation"
attributes(dt$abuse4cat_f)$label <- "4-level abuse category observed in the current observation"

# select(dt, id, days, phyab, verbab, abuse_d, abuse4cat) %>% filter(abuse_d != -2 & abuse4cat == -2)
# sum(is.na(dt$abuse4cat))

CrossTable(dt$abuse4cat)
# Abuse not measured:                              1,059,536 observations
# Can't determine, answered phyab, but not verbab: 752 observations
# Can't determine, answered verbab, but not phyab: 423 observations
# No:                                              336,385 observations
# Experienced verbal abuse only:                   31,671 observations
# Experienced physical abuse only:                 775 observations
# Experienced physical and verbal abuse:           2,906 observations
```

There are more people in the unable to determine groups for 4cat than for any abuse. For example, if someone said that the had experienced physical abuse, and had a missing value for verbal abuse, then we could say that they experienced abuse (abuse_d == 1), but we cannot classify them into one of the 4-level categories. We could say that they experienced physical abuse, but we cannot say that they experienced physical abuse ONLY.

## Creating abuse "ever" variables

* Did some testing. In the cases below, there was a big difference in processing time between data.table (~15 secs) and dplyr (~1.5 mins)

### Verbal abuse at any point

```{r}
dt[, verbab_ever := if_else(all(verbab_d == -3, na.rm = TRUE), -3, # Abuse not measured
                    if_else(any(verbab_d ==  1, na.rm = TRUE),  1, # Experienced verbal abuse ever
                    if_else(any(verbab_d == -1, na.rm = TRUE), -1, # Unable to determine
                    if_else(any(verbab_d ==  0, na.rm = TRUE),  0, # Did not experience any verbal abuse ever
                    NA_real_)))),
  by = id]

# Make factor version
dt[, verbab_ever_f := factor(verbab_ever, labels = c("Abuse never measured", "Unable to determine", "No", "Yes"))]

attributes(dt$verbab_ever)$label   <- "Reported any verbab during entire follow-up"
attributes(dt$verbab_ever_f)$label <- "Reported any verbab during entire follow-up"

# select(dt, id, days, phyab, verbab, verbab_d, verbab_ever, verbab_ever_f) %>% filter(verbab_ever == -1)
# sum(is.na(dt$verbab_ever))

CrossTable(dt$verbab_ever)
# Abuse not measured:                       699 observations
# Unable to determine:                      5,865 observations
# Did not experience any verbal abuse ever: 1,181,129 observations
# Experienced verbal abuse ever:            244,755 observations
```

### How many women is that?

```{r}
dt %>% 
  group_by(verbab_ever_f) %>% 
  summarise(
    Women = n_distinct(id)
  ) %>% 
  mutate(
    Cumulative_Sum = cumsum(Women),
    Percent_of_Total = (Women / last(Cumulative_Sum) * 100) %>% round(1)
  )%>% 
  format(big.mark = ",")
# Abuse never measured: 156 women
# Unable to determine:  575 women
# No:                   134,795 women
# Yes:                  26,282 women
```

There are a lot of women (575) who, on at least one occasion, answered the question about physical abuse, but did not answer the question about verbal abuse. 

```{r}
# What is the distribution of responses to the physical abuse question among women who answered the phyical abuse question, but not the verbal abuse question?
dt %>% 
  filter(verbab_d_f == "Unable to determine") %>% 
  group_by(phyab_d_f) %>% 
  summarise(Count = n()) %>% 
  mutate(Percent = (Count / sum(Count) * 100) %>% round(1))
```

In about 96.7% of the cases when the physical abuse question was answered, but not the verbal abuse question, there was a "no" response the physical abuse question.

In the analysis of abuse at baseline, I don't think this will be a big issue; however, if I do longitudinal analysis in the future, I may need to impute these values.

### Physical abuse at any point

```{r}
dt[, phyab_ever := if_else(all(phyab_d == -3, na.rm = TRUE), -3, # Abuse not measured
                   if_else(any(phyab_d ==  1, na.rm = TRUE),  1, # Experienced physical abuse ever
                   if_else(any(phyab_d == -1, na.rm = TRUE), -1, # Unable to determine
                   if_else(any(phyab_d ==  0, na.rm = TRUE),  0, # Did not experience any physical abuse ever
                   NA_real_)))),
  by = id]

# Make factor version
dt[, phyab_ever_f := factor(phyab_ever, labels = c("Abuse never measured", "Unable to determine", "No", "Yes"))]

attributes(dt$phyab_ever)$label   <- "Reported any phyab during entire follow-up"
attributes(dt$phyab_ever_f)$label <- "Reported any phyab during entire follow-up"

# select(dt, id, days, phyab, verbab, phyab_d, phyab_ever, phyab_ever_f) %>% filter(phyab_ever == 1)
# sum(is.na(dt$phyab_ever))

CrossTable(dt$phyab_ever)
# Abuse not measured:                         699 observations
# Unable to determine:                        4,154 observations
# Did not experience any physical abuse ever: 1,396,872 observations
# Experienced physical abuse ever:            30,723 observations
```

### How many women is that?

```{r}
dt %>% 
  group_by(phyab_ever_f) %>% 
  summarise(
    Women = n_distinct(id)
  ) %>% 
  mutate(
    Cumulative_Sum = cumsum(Women),
    Percent_of_Total = (Women / last(Cumulative_Sum) * 100) %>% round(1)
  )%>% 
  format(big.mark = ",")
# Abuse never measured: 156 women
# Unable to determine:  404 women
# No:                   157,959 women
# Yes:                  3,289 women
```

There are a lot of women (404) who, on at least one occasion, answered the question about verbal abuse, but did not answer the question about physical abuse. 

```{r}
# What is the distribution of responses to the physical abuse question among women who answered the phyical abuse question, but not the verbal abuse question?
dt %>% 
  filter(phyab_d_f == "Unable to determine") %>% 
  group_by(verbab_d_f) %>% 
  summarise(Count = n()) %>% 
  mutate(Percent = (Count / sum(Count) * 100) %>% round(1))
```

In about 79.7% of the cases when the verbal abuse question was answered, but not the physical abuse question, there was a "no" response the verbal abuse question.

In the analysis of abuse at baseline, I don't think this will be a big issue; however, if I do longitudinal analysis in the future, I may need to impute these values.

## Any abuse (physical or verbal) at any point

```{r}
dt[, abuse_ever := if_else(phyab_ever == 1  | verbab_ever ==  1,  1, # Experienced abuse ever
                   if_else(phyab_ever == 0  & verbab_ever ==  0,  0, # Did not experience any abuse ever
                   if_else(phyab_ever == -3 & verbab_ever == -3, -3, # Abuse not measured
                   -1,                                               # Unable to determine
                   NA_real_)))]

# Make factor version
dt[, abuse_ever_f := factor(abuse_ever, labels = c("Abuse never measured", "Unable to determine", "No", "Yes"))]

attributes(dt$abuse_ever)$label   <- "Reported any abuse during entire follow-up"
attributes(dt$abuse_ever_f)$label <- "Reported any abuse during entire follow-up"

# select(dt, id, days, phyab_ever, verbab_ever, abuse_ever, abuse_ever_f) %>% filter(abuse_ever == 1)
# sum(is.na(dt$abuse_ever))

CrossTable(dt$abuse_ever)
# Abuse not measured:                699 observations
# Unable to determine:               8,634 observations
# Did not experience any abuse ever: 1,172,939 observations
# Experienced abuse ever:            250,176 observations
```

## How many women reported physical or verbal at some point?

* Not necessarily in the same observation.

```{r}
dt %>% 
  group_by(abuse_ever_f) %>% 
  summarise(
    Women = n_distinct(id)
  ) %>% 
  mutate(
    Cumulative_Sum = cumsum(Women),
    Percent_of_Total = (Women / last(Cumulative_Sum) * 100) %>% round(1)
  ) %>% 
  format(big.mark = ",")
# Abuse never measured: 156 women
# Unable to determine:  846 women
# No:                   133,929 women
# Yes:                  26,877 women
```

```{r save_analysis_05}
# Save progress
analysis_05 <- as_tibble(dt)
write_rds(analysis_05, path = "../data/analysis_05.rds")
```









-------------------------------------------------------------------------------

# Create baseline abuse status

-------------------------------------------------------------------------------

```{r load_analysis_05}
# Load data
analysis_05 <- read_rds("../data/analysis_05.rds")
check_data(analysis_05) # 1,432,448 observations and 72 variables
```

```{r}
dt <- as.data.table(analysis_05)
```

## Create baseline physical abuse group based individual woman's initial observed status (not necissarily at observation 1)

```{r}
# Tag the first observation for each person with an observed value for phyab
dt[phyab_d != -1 & phyab_d != -3, first_phyab_obs := seq_len(.N) == 1, by = id]
attributes(dt$first_phyab_obs)$label <- "Tag first non-missing value for phyab"
# select(dt, id, days, phyab_d, first_phyab_obs)
```

```{r}
# Phyab status at fist observed value (not necissarily at observation 1)
dt[first_phyab_obs == TRUE, first_phyab := phyab]
dt[, first_phyab := na.omit(first_phyab)[1], by = id]
attributes(dt$first_phyab)$label <- "Phyab status at first non-missing value for phyab"
# select(dt, id, days, phyab, phyab_d, first_phyab_obs, first_phyab) %>% filter(first_phyab == 3)
```

## Create baseline verbal abuse group based individual woman's initial observed status (not necissarily at observation 1)

```{r}
# Tag the first observation for each person with an observed value for verbab
dt[verbab_d != -1 & verbab_d != -3, first_verbab_obs := seq_len(.N) == 1, by = id]
attributes(dt$first_verbab_obs)$label <- "Tag first non-missing value for verbab"
# select(dt, id, days, verbab_d, first_verbab_obs)
```

```{r}
# Verbab status at fist observed value (not necissarily at observation 1)
dt[first_verbab_obs == TRUE, first_verbab := verbab]
dt[, first_verbab := na.omit(first_verbab)[1], by = id]
attributes(dt$first_verbab)$label <- "Verbab status at first non-missing value for verbab"
# select(dt, id, days, verbab, verbab_d, first_verbab_obs, first_verbab) %>% filter(first_verbab == 3)
```
				
## Create dichotomous abuse / no abuse (physical or verbal) at baseline based on woman's initial observed status
	
* Tag the first observation for each woman with an observed value for verbab OR phyab

* Use and instead of or because if one type of abuse is missing, then abuse status is unknown. If abuse status is unknown, then it isn't really their first observation of abuse.

* No, the first observation is the first observation, even if one type is missing for the first observation

```{r}
# Tag the first time first_phyab_obs OR first_verbab_obs is TRUE
dt[, x := first_phyab_obs == TRUE | first_verbab_obs == TRUE]
dt[x == TRUE, first_ab_obs := seq_len(.N) == 1, by = id]
attributes(dt$first_verbab_obs)$label <- "Tag first observed value of any abuse"
# select(dt, id, days, phyab_d, verbab_d, first_phyab_obs, first_verbab_obs, first_ab_obs) %>%
#   filter(id %in% c(103039, 103617, 104299, 104353, 112203))
dt$x <- NULL
```

```{r}
# How many women have a first abuse observation?
dt %>% 
  summarise(
    `Total in Data` = unique(id) %>% length(),
    `Total with first_ab_obs` = sum(first_ab_obs, na.rm = TRUE),
    `Total without first_ab_obs` = `Total in Data` - `Total with first_ab_obs`,
    `Percent with at least one obs` = `Total with first_ab_obs` / `Total in Data` * 100
  )

# 156 matches the expected number from above - 156 women never have any measure of abuse.
```

```{r}
# At the first abuse observation, how many are complete (i.e., a measure of phyab AND verbab)?
dt %>% 
  summarise(
    `Phyab Missing`    = sum(first_ab_obs == TRUE & (phyab_d == -1 | phyab_d == -3), na.rm = TRUE),
    `Verbab Missing`   = sum(first_ab_obs == TRUE & (verbab_d == -1 | verbab_d == -3), na.rm = TRUE),
    Total              = `Phyab Missing` + `Verbab Missing`,
    `Total Complete`   = 161808 - Total,
    `Percent Complete` = `Total Complete` / 161808 * 100
  )

# 429 women are missing a measure for one form of abuse at the first occation that they answer the question about either form of abuse.
```

99.9 percent of women have at least one measure of one form of abuse. Additionally, at their first measure of abuse, 99.7% of women have either a yes or no response for BOTH physical AND verbal abuse.

```{r}
# At the first abuse observation, how many are incomplete?
# How many, when incomplete, have a yes response to one type of abuse or the other?
dt %>% 
  mutate(
    incomplete = first_ab_obs == TRUE & ((phyab_d == -1 | phyab_d == -3) | (verbab_d == -1 | verbab_d == -3)),
    inc_w_yes  = incomplete == TRUE & (phyab_d == 1 | verbab_d == 1)
  ) %>% 
  summarise(
    Incomplete = sum(incomplete, na.rm = TRUE),
    `Incomplete with Yes` = sum(inc_w_yes, na.rm = TRUE),
    `Unable to determine` = Incomplete - `Incomplete with Yes`
  )

# 429 women are missing a measure for one form of abuse at the first occation that they answer the question about either form of abuse.
```

At the first observation in which they give an response to either abuse question, 429 women answer only one of the abuse questions. Of those, 60 said yes to the question they answered, and 369 said no to the question they answered - leaving us unable to determine their abuse status.

## Any abuse (physical or verbal) at baseline

```{r}
dt[first_ab_obs == TRUE, 
   first_ab := if_else(phyab_d ==  1 | verbab_d ==  1,  1, # Experienced abuse at baseline
               if_else(phyab_d ==  0 & verbab_d ==  0,  0, # Did not experience any abuse at baseline
               if_else(phyab_d == -3 & verbab_d == -3, -3, # Abuse not measured
               -1,                                         # Unable to determine
               NA_real_)))]

# Make factor version
dt[, first_ab_f := factor(first_ab, levels = c(-3, -1, 0, 1), 
                          labels = c("Abuse never measured", "Unable to determine", "No", "Yes"))]

attributes(dt$first_ab)$label   <- "Abuse status at first measure"
attributes(dt$first_ab_f)$label <- "Abuse status at first measure"

# select(dt, id, days, phyab_d, verbab_d, first_ab_obs, first_ab, first_ab_f) %>% filter(first_ab == -1)

CrossTable(dt$first_ab)
# Abuse not measured:                       0 women (women w/o first measure not included)
# Unable to determine:                      369 women
# Did not experience any abuse at baseline: 142,931 women
# Experienced abuse at baseline:            18,352 women
```

### Distribute firstab across all observations within id

```{r}
dt[, first_ab := na.omit(first_ab)[1], by = id]
# select(dt, id, days, phyab_d, verbab_d, first_ab_obs, first_ab)
```
	
## Create categorical variable (no abuse, verbal only, physical only, physical and verbal) based on woman's initial observed status

```{r}
dt[first_ab_obs == TRUE, 
   first_abuse4cat := if_else(phyab_d ==   1 & verbab_d ==  1, 3, # Experienced physical and verbal at baseline
                      if_else(phyab_d ==   1 & verbab_d ==  0, 2, # Physical only
                      if_else(phyab_d ==   0 & verbab_d ==  1, 1, # Verbal only
                      if_else(phyab_d ==   0 & verbab_d ==  0, 0, # No abuse
                      if_else(phyab_d ==  -1,                 -1, # Answered verbab, but not phyab
                      if_else(verbab_d == -1,                 -2, # Answered phyab, but not verbab
                                                              -3, # Abuse not measured
                      NA_real_))))))]

# Make factor version
dt[, first_abuse4cat_f := factor(first_abuse4cat, levels = c(3, 2, 1, 0, -1, -2, -3), 
                          labels = c("Experienced P and V abuse", "Experienced P abuse only", 
                                     "Experienced V abuse only", "Did not experience abuse", 
                                     "Can't determine V no P", "Can't determine P no V", "Abuse not measured"))]

attributes(dt$first_abuse4cat)$label   <- "4-level abuse status at baseline"
attributes(dt$first_abuse4cat_f)$label <- "4-level abuse status at baseline"

# select(dt, id, days, phyab_d, verbab_d, first_ab_obs, first_abuse4cat, first_abuse4cat_f) %>%
#   filter(first_abuse4cat == -2)

CrossTable(dt$first_abuse4cat)
# Abuse not measured:                              0 women (women w/o first measure not included)
# Can't determine, answered phyab, but not verbab: 288 women
# Can't determine, answered verbab, but not phyab: 141 women
# No:                                              142,931 women
# Experienced verbal abuse only:                   16,211 women
# Experienced physical abuse only:                 401 women
# Experienced physical and verbal abuse:           1,680 women
```

```{r save_analysis_06}
# Save progress
analysis_06 <- as_tibble(dt)
write_rds(analysis_06, path = "../data/analysis_06.rds")
```









-------------------------------------------------------------------------------

# Clean outcome variables: Sexual function

-------------------------------------------------------------------------------

```{r load_analysis_06}
# Load data
analysis_06 <- read_rds("../data/analysis_06.rds")
check_data(analysis_06) # 1,432,448 observations and 81 variables
```

```{r}
dt <- as.data.table(analysis_06)
```

## Sexual activity in past year

[Did you have any sexual activity with a partner in the last year?](https://www.whi.org/researchers/data/WhiDataDict/f37_ctos_inv.pdf)

```{r}
# Recode 9 to missing
dt[sexactiv == 9, sexactiv := NA_real_]
# select(dt, id, days, obs, sexactiv)
```

Many women do not have a measure for sexactiv in their first observation. Below I will create a variable that captures their sexactiv status at the first time it is measured.

```{r}
# Tag first non-missing value of sexactiv
dt[!is.na(sexactiv), first_sexactiv := seq_len(.N) == 1, by = id]
# select(dt, id, days, obs, sexactiv, first_sexactiv)
```

Because of the way the question is worded, we can carry responses backwards within the year. However, this changes the interpretation to be somethin like "where you currently sexually active on this day?"

```{r}
# Temp variable for response number
dt[!is.na(sexactiv), response_num := 1:.N, by = id]

# Temp variable for days at response
dt[!is.na(response_num), response_days := days]

# Carry backward response_days within id
dt[, response_days := na.locf(response_days, na.rm = FALSE, fromLast = TRUE), by = id]

# Absolute difference in days between days and response_days
dt[, diff := abs(response_days - days)]

# Carry backward sexactiv_f if diff <= 365
dt[diff <= 365, sexactiv := na.locf(sexactiv, na.rm = FALSE, fromLast = TRUE), by = id]

# select(dt, id, days, obs, sexactiv, response_num, response_days, diff)

# Drop temp vars
dt[, c("response_num", "response_days", "diff") := NULL]

# Create factor version
dt[, sexactiv_f := factor(sexactiv, labels = c("No", "Yes"))]

# Descriptives at first response
dt[first_sexactiv == 1, .(Women = .N), by = sexactiv_f][, Cumsum := cumsum(Women)][
  , Percent := Women / max(Cumsum) * 100][]
```

```{r}
# How many never respond?
dt[, all(is.na(first_sexactiv)), by = id][, .(`Never respond` = sum(V1))][] # 2,859
```


## Sexual satisfaction

[How satisfied are you with your current sexual activities, either with a partner or alone? (Mark
one oval.)](https://www.whi.org/researchers/data/WhiDataDict/f37_ctos_inv.pdf)

```{r}
# Recode 9 to missing
dt[satsex == 9, satsex := NA_real_]

# Create factor version
dt[, satsex_f := factor(satsex, labels = c("Very unsatisfied", "A little unsatisfied", "Somewhat satisfied",
                                           "Very satisfied"))]

# Tag first non-missing value of satsex
dt[!is.na(satsex), first_satsex := seq_len(.N) == 1, by = id]

# Descriptives at first response
dt[first_satsex == 1, .(Women = .N), by = satsex_f][, Cumsum := cumsum(Women)][
  , Percent := Women / max(Cumsum) * 100][]
```

```{r}
# How many never respond?
dt[, all(is.na(first_satsex)), by = id][, .(`Never respond` = sum(V1))][] # 18,064
```

```{r}
# Create a dichotomous version
dt[, satisfied := if_else(satsex_f == "Somewhat satisfied" | satsex_f == "Very satisfied", 1, 0, NA_real_)]

# Create factor version
dt[, satisfied_f := factor(satisfied, labels = c("No", "Yes"))]

# Descriptives at first response
dt[first_satsex == 1, .(Women = .N), by = satisfied_f][, Cumsum := cumsum(Women)][
  , Percent := Women / max(Cumsum) * 100][]
```

## Sexual frequency satisfaction

[Are you satisfied with the frequency of your sexual activity, or would you like to have sex more or
less often? (Mark one oval.)](https://www.whi.org/researchers/data/WhiDataDict/f37_ctos_inv.pdf)

```{r}
# Recode 9 to missing
dt[satfrqsx == 9, satfrqsx := NA_real_]

# Create factor version
dt[, satfrqsx_f := factor(satfrqsx, labels = c("Less often", "Satisfied with current frequency", "More often"))]

# Tag first non-missing value of satsex
dt[!is.na(satfrqsx), first_satfrqsx := seq_len(.N) == 1, by = id]

# Descriptives at first response
dt[first_satfrqsx == 1, .(Women = .N), by = satfrqsx_f][, Cumsum := cumsum(Women)][
  , Percent := Women / max(Cumsum) * 100][]
```

```{r}
# How many never respond?
dt[, all(is.na(first_satfrqsx)), by = id][, .(`Never respond` = sum(V1))][] # 26,229
```

```{r}
# Create a dichotomous version
dt[, freq_satisfied := if_else(satfrqsx_f == "Satisfied with current frequency", 1, 0, NA_real_)]

# Create factor version
dt[, freq_satisfied_f := factor(freq_satisfied, labels = c("No", "Yes"))]

# Descriptives at first response
dt[first_satfrqsx == 1, .(Women = .N), by = freq_satisfied_f][, Cumsum := cumsum(Women)][
  , Percent := Women / max(Cumsum) * 100][]
```

```{r save_analysis_07}
# Save progress
analysis_07 <- dt
write_rds(analysis_07, path = "../data/analysis_07.rds")
```









-------------------------------------------------------------------------------

# Cleaning covariates

-------------------------------------------------------------------------------

* Recode missing

* Create factor variables

* Distribute time-invariant variables across all observations (e.g. race)

* Carry backward "have you ever" variables (e.g. diabetes ever)

* Carry forward relatively time-stable variables (e.g. income)

```{r load_analysis_07}
# Load data
analysis_07 <- read_rds("../data/analysis_07.rds")
check_data(analysis_07) # 1,432,448 observations and 91 variables
```

```{r}
dt <- as.data.table(analysis_07)
```

## Distributing selected covariates across observations

```{r}
# Variables that are either time-invariant, or considered to be nearly time-invariant in this sample
time_invariant <- c("ager", "race_eth", "edu4cat","sex", "ctos", "parity")

# Distribute time-invariant variables across all observations within id
dt[, (time_invariant) := lapply(.SD, function(x) na.omit(x)[1]), 
   .SDcols = time_invariant, 
   by = id]
```

```{r}
# Carry forward "have you ever" variables
ever_vars <- c("horm", "hyst", "arthrit", "brca_f30", "cervca", "endo_f30", "ovryca", "cvd", "diab", "hypt",
               "osteopor", "pad")

dt[, (ever_vars) := lapply(.SD, function(x) na.locf(x, na.rm = FALSE)), 
   .SDcols = ever_vars, 
   by = id]
```

```{r}
# Save progress
analysis_08 <- dt
write_rds(analysis_08, path = "../data/analysis_08.rds")
```

```{r}
# Load data
analysis_08 <- read_rds("../data/analysis_08.rds")
check_data(analysis_08) # 1,432,448 observations and 91 variables
```

```{r}
dt <- as.data.table(analysis_08)
```

## Sociodemographic covariates

### Age

[Age at screening](https://www.whi.org/researchers/data/WhiDataDict/dem_ctos_inv.pdf)

```{r}
dt[, .(Missing = sum(is.na(age)), Mean = mean(age), SD = sd(age))] # Over all observations
```

### Age group

[Age group at screening](https://www.whi.org/researchers/data/WhiDataDict/dem_ctos_inv.pdf)

```{r}
# Rename ager
setnames(dt, "ager", "age_group")

# Create factor
dt[, age_group_f := factor(age_group, labels = c("<50-59", "60-69", "70-79+"))]

# Descriptives at first obs
dt[obs == 1, .(Women = .N), by = age_group_f][, Cumsum := cumsum(Women)][
  , Percent := Women / max(Cumsum) * 100][]
```

### Race / Ethnicity

[Ethnicity](https://www.whi.org/researchers/data/WhiDataDict/dem_ctos_inv.pdf)

```{r}
# Create factor
dt[, race_eth_f := factor(race_eth, labels = c("White", "AA", "Hispanic", "Other"))]

# Descriptives at first obs
dt[obs == 1, .(Women = .N), by = race_eth_f][, Cumsum := cumsum(Women)][
  , Percent := Women / max(Cumsum) * 100][]
# dt %>% filter(is.na(race_eth)) %>% select(id, days, race_eth) %>% summarise(length(unique(id)))
# 413 people matches WHI documentation
```

### Education

[Edcuation](https://www.whi.org/researchers/data/WhiDataDict/dem_ctos_inv.pdf)

```{r}
# Create factor
dt[, edu4cat_f := factor(edu4cat, labels = c("<HS", "HS Grad", "Some College or Tech School", "College Grad"))]

# Descriptives at first obs
dt[obs == 1][order(edu4cat_f), .(Women = .N), by = edu4cat_f][, Cumsum := cumsum(Women)][
  , Percent := Women / max(Cumsum) * 100][]
# 1,216 missing matches WHI documentation
```

### Income

[Family income](https://www.whi.org/researchers/data/WhiDataDict/dem_ctos_inv.pdf)

```{r}
# How stable is income over time?

# Take a look
# select(dt, id, days, inc5cat, inc5cat_f20)

# How often are inc5cat and inc5cat_f20 measured on the same day?
# 3,148
# On those 3,148 days, how often do inc5cat and inc5cat_f20 disagree?
# dt[!is.na(inc5cat) & !is.na(inc5cat_f20), .(id, days, inc5cat, inc5cat_f20)][inc5cat != inc5cat_f20]
# All on day zero and all agree

# Create a combined income variable
dt[!is.na(inc5cat) & !is.na(inc5cat_f20), combined := inc5cat]
dt[is.na(combined), combined := sum(inc5cat, inc5cat_f20, na.rm = TRUE), by = .(id, days)]
dt[combined == 0, combined := NA_real_]
# select(dt, id, days, inc5cat, inc5cat_f20, combined)

# Does combined change from measure to measure?
dt[!is.na(combined), length(unique(combined)) != 1, by = id][
  , .(`Women with Income` = .N, `Income change` = sum(V1))]
```

Income is time-invariant. Will distribute across all observations.

```{r}
# Drop unneeded income variables
dt[, c("inc5cat_f20", "combined") := NULL]

# Distribute across observations
dt[, inc5cat := na.omit(inc5cat)[1], by = id]

# Create factor
dt[, inc5cat_f := factor(inc5cat, labels = c("20,000 or less", "20-34,999", "35-49,999", "50-74,999",
                                             "75,000+"))]

# Descriptives at first obs
dt[days == 0][order(inc5cat_f), .(Women = .N), by = inc5cat_f][, Cumsum := cumsum(Women)][
  , Percent := Women / max(Cumsum) * 100][]
# 10,874 missing match WHI documentation for missing and don't know.
```

### Marital status

* [Married](https://www.whi.org/researchers/data/WhiDataDict/f37_ctos_inv.pdf) is worded, "Are you currently married or in an intimate relationship with at least one person?"

* [Marital](https://www.whi.org/researchers/data/WhiDataDict/f20_ctos_inv.pdf) is worded, "What is your current marital status? (Mark the one that best describes you.)":   
1. Never married    
2. Divorced or separated    
3. Widowed   
4. Presently married   
5. Marriage-like relationship    

Recode the marital to 1, 2, and 3 vs. 4 & 5. Should make married and marital roughly comparible.

```{r}
dt[, marital := if_else(marital %in% c(1, 2, 3), 0, 
                if_else(marital %in% c(4, 5),    1,
                NA_real_))]
# select(dt, id, days, married, marital)
```

```{r}
# Carry forward married
dt[, married := na.locf(married, na.rm = FALSE), by = id]

# Carry forward marital
dt[, marital := na.locf(marital, na.rm = FALSE), by = id]
# select(dt, id, days, married, marital)
```

```{r}
# Which variable has the greatest amount of missing?

cat("Number of missing values for married =", format(sum(is.na(dt$married)), big.mark = ",")) # 373,512
cat("\n")
cat("Number of missing values for marital =", format(sum(is.na(dt$marital)), big.mark = ",")) # 263,161
```

Marital has fewer missing values. 

We previously tried augmenting missing values in marital with data from married - when available. However, sometime there were disagreements. Trying to pick a winner in the disagreements may introduce bias. Setting disagreements to NA results in a greater number of missing than just using marital as it is. So, we'll just use marital as it is.

```{r}
# Drop married and rename marital
dt$married <- NULL
setnames(dt, "marital", "married")
```

```{r}
# Create factor version
dt[, married_f := factor(married, labels = c("Not married or intimate relationship", 
                                             "Married or intimate relationship"))]

# Descriptives at day 0
dt[days == 0][order(married_f), .(Women = .N), by = married_f][, Cumsum := cumsum(Women)][
  , Percent := Women / max(Cumsum) * 100][]
```

### Sexual orientation

[Regardless of whether you are currently sexually active, which response best describes who you
have had sex with over your adult lifetime?](https://www.whi.org/researchers/data/WhiDataDict/f37_ctos_inv.pdf)

```{r}
# Recode 9 to missing
dt[sex == 9, sex := NA_real_]

# Create factor
dt[, sex_f := factor(sex, labels = c("Have never had sex", "Sex with a woman or with women", 
                                     "Sex with a man or with men", "Sex with both men and women"))]

# Descriptives at day 0
dt[days == 0][order(sex_f), .(Women = .N), by = sex_f][, Cumsum := cumsum(Women)][
  , Percent := Women / max(Cumsum) * 100][]
```

### CTOS

[Study component](https://www.whi.org/researchers/data/WhiDataDict/dem_ctos_inv.pdf)

```{r}
# Create factor version
dt[, ctos_f := factor(ctos, labels = c("CT", "OS"))]

# Descriptives at first observation
dt[obs == 1, .(Women = .N), by = ctos_f][, Cumsum := cumsum(Women)][
  , Percent := Women / max(Cumsum) * 100][]
```

### Parity

[Number of Term Pregnancies. Computed from Form 31, questions 7, 7.6 and 7.7. Number of pregnancies lasting at least 6 months. Equals -1 if never pregnant.](https://www.whi.org/researchers/data/WhiDataDict/f31_ctos_inv.pdf)

```{r}
# Recode -1 (never pregnant) to 0 (Never had term pregnancy)
dt[parity == -1, parity := 0]

# Create factor version
dt[, parity_f := factor(parity, labels = c("Never had term pregnancy", "1", "2", "3", "4", "5+"))]

# Descriptives at first observation
dt[obs == 1][order(parity_f), .(Women = .N), by = parity_f][, Cumsum := cumsum(Women)][
  , Percent := Women / max(Cumsum) * 100][]
```

## Health behaviors

### Physical activity

[Total energy expend from recreational phys activity (MET-hours/week). Computed from Form 34, questions 6, 6.1, 6.2, 7.1, 7.2, 7.3, 7.4, 7.5, and 7.6. Total MET-hours per week. Expenditure of energy from recreational physical activity (includes walking, mild, moderate and strenuous physical activity in kcal/week/kg).](https://www.whi.org/researchers/data/WhiDataDict/f34_ctos_inv.pdf)

```{r}
dt[, .(Missing = sum(is.na(texpwk)), Mean = mean(texpwk, na.rm = TRUE), SD = sd(texpwk, na.rm = TRUE))]
```

### Alcohol use

[Alcohol servings per week. Computed from Form 34, questions 3 and 3.1; Form 60 (FFQ), wine, beer and liquor servings. Number of servings per week of beer, wine and/or liquor based on a medium serving size which is 12oz of beer, 6oz of wine and 1.5 oz of liquor. If all three variables are missing, set to missing.](https://www.whi.org/researchers/data/WhiDataDict/f34_ctos_inv.pdf)

```{r}
dt[, .(Missing = sum(is.na(alcswk)), Mean = mean(alcswk, na.rm = TRUE), SD = sd(alcswk, na.rm = TRUE))]
```

[Dietary Alcohol (g). Includes alcohol from beer, wine, and liquor, as well as from foods. Some foods contain alcohol due to minute amounts of alcohol in vanilla extract, almond extract etc used in baking.](https://www.whi.org/researchers/data/WhiDataDict/f60_ctos_inv.pdf)

```{r}
dt[, .(Missing = sum(is.na(f60alc)), Mean = mean(f60alc, na.rm = TRUE), SD = sd(f60alc, na.rm = TRUE))]
```

[Form 60 (FFQ), wine, beer and liquor servings. Number of servings per week of beer, wine and/or liquor based on a medium serving size which is 12oz of beer, 6oz of wine and 1.5 oz of liquor. If all three variables are missing, set to missing.](https://www.whi.org/researchers/data/WhiDataDict/f60_ctos_inv.pdf)

```{r}
dt[, .(Missing = sum(is.na(f60alcwk)), Mean = mean(f60alcwk, na.rm = TRUE), SD = sd(f60alcwk, na.rm = TRUE))]
```

### Caffeine use

[Dietary Caffeine (mg)](https://www.whi.org/researchers/data/WhiDataDict/f60_ctos_inv.pdf)

```{r}
dt[, .(Missing = sum(is.na(f60caff)), Mean = mean(f60caff, na.rm = TRUE), SD = sd(f60caff, na.rm = TRUE))]
```

### Smoking status

[Do you smoke cigarettes now](https://www.whi.org/researchers/data/WhiDataDict/f35_ct_inv.pdf)

```{r}
# Create factor version
dt[, smoknow_f := factor(smoknow, labels = c("No", "Yes"))]

# Tag first non-missing value
dt[!is.na(smoknow), first_smoknow := seq_len(.N) == 1, by = id]

# Descriptives at first response
dt[first_smoknow == 1][order(smoknow_f), .(Women = .N), by = smoknow_f][, Cumsum := cumsum(Women)][
  , Percent := Women / max(Cumsum) * 100][]
```

```{r}
# How many never respond?
dt[, all(is.na(first_smoknow)), by = id][, .(`Never respond` = sum(V1))][] # 49,279
```

[Smoking status. Computed from Form 34, questions 1, 1.2, and 1.5. Combines questions into a three category smoking status variable (never/past/current).](https://www.whi.org/researchers/data/WhiDataDict/f34_ctos_inv.pdf)

```{r}
# Create factor version
dt[, smoking_f := factor(smoking, labels = c("Never smoked", "Past smoker", "Current smoker"))]

# Tag first non-missing value
dt[!is.na(smoking), first_smoking := seq_len(.N) == 1, by = id]

# Descriptives at first response
dt[first_smoking == 1, .(Women = .N), by = smoking_f][, Cumsum := cumsum(Women)][
  , Percent := Women / max(Cumsum) * 100][]
```

```{r}
# How many never respond?
dt[, all(is.na(first_smoking)), by = id][, .(`Never respond` = sum(V1))][] # 2,126
```

Smoking is much more complete. Use it in the analysis.

```{r}
# Clean up
dt[, c("smoknow", "smoknow_f", "first_smoknow", "first_smoking") := NULL]
```

### Hormones ever

[Female hormones ever. Did you ever use any female hormones like estrogen (Premarin) or progesterone (Provera)? These might be pills, skin patches, implants, creams, suppositories, shots, or birth control pills. (This does not include birth control pills you used before you were 50.)](https://www.whi.org/researchers/data/WhiDataDict/f2_ctos_inv.pdf)

```{r}
# Create a factor version
dt[, horm_f := factor(horm, labels = c("No", "Yes"))]

# Descriptives at first observation
dt[obs == 1, .(Women = .N), by = horm_f][, Cumsum := cumsum(Women)][
  , Percent := Women / max(Cumsum) * 100][]
```

### Hormones now

[Female hormones now. Are you using female hormones now?](https://www.whi.org/researchers/data/WhiDataDict/f2_ctos_inv.pdf)

```{r}
# Create factor version
dt[, hormnw_f := factor(hormnw, labels = c("No", "Yes"))]

# Tag first non-missing value
dt[!is.na(hormnw), first_hormnw := seq_len(.N) == 1, by = id]

# Descriptives at first response
dt[first_hormnw == 1, .(Women = .N), by = hormnw_f][, Cumsum := cumsum(Women)][
  , Percent := Women / max(Cumsum) * 100][]
```

```{r}
# Clean up
dt[, first_hormnw := NULL]
```

### Taking SSRI

[Medication Therapeutic Class Code](https://www.whi.org/researchers/data/WhiDataDict/f44_ctos_inv.pdf)

tccode = 581600

```{r}
# Create factor version
dt[, ssri_f := factor(ssri, labels = c("No", "Yes"))]

# Descriptives at first observation
dt[obs == 1][order(ssri_f), .(Women = .N), by = ssri_f][, Cumsum := cumsum(Women)][
  , Percent := Women / max(Cumsum) * 100][]
```

## Health and Wellness

### Quality of life

[Overall, how you would rate your quality of life? (Mark one oval in the box below.)](https://www.whi.org/researchers/data/WhiDataDict/f37_ctos_inv.pdf)

Scale from 1 to 10 with 10 being the best.

```{r}
dt[, .(Missing = sum(is.na(lifequal)), Mean = mean(lifequal, na.rm = TRUE), SD = sd(lifequal, na.rm = TRUE))]
```

### Depression

[Shortened CES-D/DIS Screening Instrument. Computed from Form 36/37, questions 103-108, 109, and 110. Source: Center for Epidemiological Studies; depression scale (CES-D, short form). PSHTDEP ranges from 0 to 1 with a higher score indicating a greater likelihood of depression. Cutoff values of .06 and .009 have been used to indicate depression.](https://www.whi.org/researchers/data/WhiDataDict/f37_ctos_inv.pdf)

```{r}
dt[, .(Missing = sum(is.na(pshtdep)), Mean = mean(pshtdep, na.rm = TRUE), SD = sd(pshtdep, na.rm = TRUE))]
```

### BMI

[Body-mass Index (BMI), kg/m2. If a participant's BMI is greater than 70, BMI is missing.](https://www.whi.org/researchers/data/WhiDataDict/f80_ctos_inv.pdf)

```{r}
dt[, .(Missing = sum(is.na(bmi)), Mean = mean(bmi, na.rm = TRUE), SD = sd(bmi, na.rm = TRUE))]
```

### General health

[In general, would you say your health is (Mark one oval.)](https://www.whi.org/researchers/data/WhiDataDict/f37_ctos_inv.pdf)

```{r}
# Create factor version
dt[, genhel_f := factor(genhel, labels = c("Excellent", "Very good", "Good", "Fair", "Poor"))]

# Tag first non-missing value
dt[!is.na(genhel), first_genhel := seq_len(.N) == 1, by = id]

# Descriptives at first response
dt[first_genhel == 1][order(genhel_f), .(Women = .N), by = genhel_f][, Cumsum := cumsum(Women)][
  , Percent := Women / max(Cumsum) * 100][]
```

```{r}
# Dichotomize
dt[, good_health := if_else(genhel_f == "Excellent" | genhel_f == "Very good", 1, 0, NA_real_)]

# Factor version
dt[, good_health_f := factor(good_health, labels = c("No", "Yes"))]

# Descriptives at first response
dt[first_genhel == 1, .(Women = .N), by = good_health_f][, Cumsum := cumsum(Women)][
  , Percent := Women / max(Cumsum) * 100][]
```


```{r}
# Clean up
dt[, first_genhel := NULL]
```

### Hysterectomy ever

[Did you ever have a hysterectomy? (This is an operation to take out your uterus or womb.)](https://www.whi.org/researchers/data/WhiDataDict/f2_ctos_inv.pdf)

```{r}
# Create factor version
dt[, hyst_f := factor(hyst, labels = c("No", "Yes"))]

# Descriptives at first observation
dt[obs == 1, .(Women = .N), by = hyst_f][, Cumsum := cumsum(Women)][
  , Percent := Women / max(Cumsum) * 100][]
```

### Night sweats

[Below is a list of symptoms people sometimes have. For each item, mark the one oval that best
describes how bothersome the symptom was during the past 4 weeks for you. Be sure to mark
one oval on each line. Night sweats](https://www.whi.org/researchers/data/WhiDataDict/f37_ctos_inv.pdf)

```{r}
# Create factor version
dt[, nightswt_f := factor(nightswt, labels = c("Symptom did not occur", "Symptom was mild", 
                                               "Symptom was moderate", "Symptom was severe"))]

# Tag first non-missing value
dt[!is.na(nightswt), first_nightswt := seq_len(.N) == 1, by = id]

# Descriptives at first response
dt[first_nightswt == 1, .(Women = .N), by = nightswt_f][, Cumsum := cumsum(Women)][, Percent := Women / max(Cumsum) * 100][]
```

```{r}
# Dichotomize
dt[, night_sweats := if_else(nightswt_f == "Symptom did not occur", 0, 1, NA_real_)]

# Create factor version
dt[, night_sweats_f := factor(night_sweats, labels = c("No", "Yes"))]

# Descriptives
dt[first_nightswt == 1, .(Women = .N), by = night_sweats_f][, Cumsum := cumsum(Women)][
  , Percent := Women / max(Cumsum) * 100][]
```

```{r}
# Clean up
dt[, first_nightswt := NULL]
```


### Hot flashes

[Below is a list of symptoms people sometimes have. For each item, mark the one oval that best
describes how bothersome the symptom was during the past 4 weeks for you. Be sure to mark
one oval on each line. Hot flashes](https://www.whi.org/researchers/data/WhiDataDict/f37_ctos_inv.pdf)

```{r}
# Create factor version
dt[, hotflash_f := factor(hotflash, labels = c("Symptom did not occur", "Symptom was mild", 
                                               "Symptom was moderate", "Symptom was severe"))]

# Tag first non-missing value
dt[!is.na(hotflash), first_hotflash := seq_len(.N) == 1, by = id]

# Descriptives at first response
dt[first_hotflash == 1][order(hotflash_f), .(Women = .N), by = hotflash_f][, Cumsum := cumsum(Women)][
  , Percent := Women / max(Cumsum) * 100][]
```

```{r}
# Dichotomize
dt[, hot_flashes := if_else(hotflash_f == "Symptom did not occur", 0, 1, NA_real_)]

# Create factor version
dt[, hot_flashes_f := factor(hot_flashes, labels = c("No", "Yes"))]

# Descriptives
dt[first_hotflash == 1, .(Women = .N), by = hot_flashes_f][, Cumsum := cumsum(Women)][
  , Percent := Women / max(Cumsum) * 100][]
```

```{r}
# Clean up
dt[, first_hotflash := NULL]
```

### Vaginal dryness

[Below is a list of symptoms people sometimes have. For each item, mark the one oval that best
describes how bothersome the symptom was during the past 4 weeks for you. Be sure to mark
one oval on each line. Vaginal or genital dryness](https://www.whi.org/researchers/data/WhiDataDict/f37_ctos_inv.pdf)

```{r}
# Create factor version
dt[, vagdry_f := factor(vagdry, labels = c("Symptom did not occur", "Symptom was mild", 
                                               "Symptom was moderate", "Symptom was severe"))]
# Tag first non-missing value
dt[!is.na(vagdry), first_vagdry := seq_len(.N) == 1, by = id]

# Descriptives at first response
dt[first_vagdry == 1][order(vagdry_f), .(Women = .N), by = vagdry_f][, Cumsum := cumsum(Women)][
  , Percent := Women / max(Cumsum) * 100][]
```

```{r}
# Dichotomize
dt[, vag_dry := if_else(vagdry_f == "Symptom did not occur", 0, 1, NA_real_)]

# Create factor version
dt[, vag_dry_f := factor(vag_dry, labels = c("No", "Yes"))]

# Descriptives
dt[first_vagdry == 1, .(Women = .N), by = vag_dry_f][, Cumsum := cumsum(Women)][
  , Percent := Women / max(Cumsum) * 100][]
```

```{r}
# Clean up
dt[, first_vagdry := NULL]
```

### Urinary incontinence

[Have you ever leaked even a very small amount of urine involuntarily and you couldn't control it?](https://www.whi.org/researchers/data/WhiDataDict/f37_ctos_inv.pdf)

```{r}
# Create factor version
dt[, incont_f := factor(incont, labels = c("No", "Yes"))]

# Tag first non-missing value
dt[!is.na(incont), first_incont := seq_len(.N) == 1, by = id]

# Descriptives at first response
dt[first_incont == 1, .(Women = .N), by = incont_f][, Cumsum := cumsum(Women)][
  , Percent := Women / max(Cumsum) * 100][]
```

```{r}
# Clean up
dt[, first_incont := NULL]
```

### Atrophy

[Not going to use atrophy. Only asked of HT arm.](https://www.whi.org/researchers/data/WhiDataDict/f81_ht_inv.pdf)

### Chronic disease

Make a single categorical variable - disease X only and multiple.

First clean each individual chronic disease variable.

#### Arthritis

[Did your doctor ever say that you had arthritis?](https://www.whi.org/researchers/data/WhiDataDict/f30_ctos_inv.pdf)

```{r}
# Create factor version
dt[, arthrit_f := factor(arthrit, labels = c("No", "Yes"))]

# Descriptives at first observation
dt[, .(Obs = .N), by = arthrit_f][, Cumsum := cumsum(Obs)][, Percent := Obs / max(Cumsum) * 100][]
```

#### Cancer - Breast

[What kind of cancer did you have? (Mark "No" or "Yes" for each type of cancer.) Breast](https://www.whi.org/researchers/data/WhiDataDict/f30_ctos_inv.pdf)

```{r}
# Create factor version
dt[, brac_f := factor(brca_f30, labels = c("No", "Yes"))]

# Descriptives at first observation
dt[, .(Obs = .N), by = brac_f][, Cumsum := cumsum(Obs)][, Percent := Obs / max(Cumsum) * 100][]
```

#### Cancer - Cervix

[What kind of cancer did you have? (Mark "No" or "Yes" for each type of cancer.) Cervix (opening
to the uterus or womb)](https://www.whi.org/researchers/data/WhiDataDict/f30_ctos_inv.pdf)

```{r}
# Create factor version
dt[, cervca_f := factor(cervca, labels = c("No", "Yes"))]

# Descriptives at first observation
dt[, .(Obs = .N), by = cervca_f][, Cumsum := cumsum(Obs)][, Percent := Obs / max(Cumsum) * 100][]
```

#### Cancer - Endometrial

[What kind of cancer did you have? (Mark "No" or "Yes" for each type of cancer.) Endometrium
(lining of the uterus or womb)](https://www.whi.org/researchers/data/WhiDataDict/f30_ctos_inv.pdf)

```{r}
# Create factor version
dt[, endo_f := factor(endo_f30, labels = c("No", "Yes"))]

# Descriptives at first observation
dt[, .(Obs = .N), by = endo_f][, Cumsum := cumsum(Obs)][, Percent := Obs / max(Cumsum) * 100][]
```

#### Cancer - Ovarian

[What kind of cancer did you have? (Mark "No" or "Yes" for each type of cancer.) Ovary](https://www.whi.org/researchers/data/WhiDataDict/f30_ctos_inv.pdf)

```{r}
# Create factor version
dt[, ovryca_f := factor(ovryca, labels = c("No", "Yes"))]

# Descriptives at first observation
dt[, .(Obs = .N), by = ovryca_f][, Cumsum := cumsum(Obs)][, Percent := Obs / max(Cumsum) * 100][]
```

#### Cardiovascular disease

[Has a doctor ever told you that you had heart problems, problems with your blood circulation, or
blood clots?](https://www.whi.org/researchers/data/WhiDataDict/f30_ctos_inv.pdf)

```{r}
# Create factor version
dt[, cvd_f := factor(cvd, labels = c("No", "Yes"))]

# Descriptives at first observation
dt[, .(Obs = .N), by = cvd_f][, Cumsum := cumsum(Obs)][, Percent := Obs / max(Cumsum) * 100][]
```

#### Diabetes ever

[Did a doctor ever say that you had sugar diabetes or high blood sugar when you were not
pregnant?](https://www.whi.org/researchers/data/WhiDataDict/f2_ctos_inv.pdf)

```{r}
# Create factor version
dt[, diab_f := factor(diab, labels = c("No", "Yes"))]

# Descriptives at first observation
dt[, .(Obs = .N), by = diab_f][, Cumsum := cumsum(Obs)][, Percent := Obs / max(Cumsum) * 100][]
```

#### Hypertension

[Did a doctor ever say that you had hypertension or high blood pressure? (Do not include high
blood pressure that you had only when you were pregnant.)](https://www.whi.org/researchers/data/WhiDataDict/f30_ctos_inv.pdf)

```{r}
# Create factor version
dt[, hypt_f := factor(hypt, labels = c("No", "Yes"))]

# Descriptives at first observation
dt[, .(Obs = .N), by = hypt_f][, Cumsum := cumsum(Obs)][, Percent := Obs / max(Cumsum) * 100][]
```

#### Osteoporosis

[Has a doctor told you that you have any of the following conditions or have you had any of the
following procedures? (Please mark all that apply.) Osteoporosis (weak, thin, or brittle bones)](https://www.whi.org/researchers/data/WhiDataDict/f30_ctos_inv.pdf)

```{r}
# Create factor version
dt[, osteopor_f := factor(osteopor, labels = c("No", "Yes"))]

# Descriptives at first observation
dt[, .(Obs = .N), by = osteopor_f][, Cumsum := cumsum(Obs)][, Percent := Obs / max(Cumsum) * 100][]
```

#### Peripheral arterial disease

[Did a doctor ever say that you had claudication or peripheral arterial disease (poor blood flow to
the legs or blocked or narrowed arteries to the legs)? Do not include varicose veins or phlebitis.](https://www.whi.org/researchers/data/WhiDataDict/f30_ctos_inv.pdf)

```{r}
# Create factor version
dt[, pad_f := factor(pad, labels = c("No", "Yes"))]

# Descriptives at first observation
dt[, .(Obs = .N), by = pad_f][, Cumsum := cumsum(Obs)][, Percent := Obs / max(Cumsum) * 100][]
```

#### Combined chronic disease variable

```{r}
# Count conditions within id and day. If any are NA then count is NA.
dt[, cd_count := sum(arthrit, brca_f30, cervca, endo_f30, ovryca, cvd, diab, hypt, osteopor, pad)
     , by = .(id, days)]
```

```{r}
# Descriptives
dt[!is.na(cd_count), .(.N, Mean = mean(cd_count), Max = max(cd_count))]
```

```{r rows.print=16}
dt[!is.na(cd_count), chronic_disease := if_else(cd_count == 0,  0, # None
                                        if_else(cd_count == 2,  1, # 2 conditions
                                        if_else(cd_count == 3,  2, # 3 conditions
                                        if_else(cd_count == 4,  3, # 4 conditions
                                        if_else(cd_count >= 5,  4, # 5+ conditions
                                        if_else(arthrit ==  1,  5, # Arthritis Only
                                        if_else(brca_f30 == 1,  6, # BC Only
                                        if_else(cervca ==   1,  7, # Cervical Only
                                        if_else(endo_f30 == 1,  8, # Endo Only
                                        if_else(ovryca ==   1,  9, # Ovarian Only
                                        if_else(cvd ==      1, 10, # CVD Only
                                        if_else(diab ==     1, 11, # Diab Only
                                        if_else(hypt ==     1, 12, # Hypt Only
                                        if_else(osteopor == 1, 13, # Ost Only
                                        if_else(pad ==      1, 14, # PAD Only
                                        NA_real_)))))))))))))))]

# Create factor version
dt[, chronic_disease_f := factor(chronic_disease, 
                                 labels = c("None", "2 conditions", "3 conditions", "4 conditions", 
                                            "5+ conditions", "Arthritis Only", "Breast Cancer Only", 
                                            "Cervical Cancer Only", "Endometrial Cancer Only", 
                                            "Ovarian Cancer Only", "Cardiovascular Disease Only",
                                            "Diabetes Only", "Hypertension Only", "Osteoporosis Only",
                                            "Peripheral Artery Disease Only"))]

# Tag first observation per person
dt[!is.na(chronic_disease_f), first_cd := seq_len(.N) == 1, by = id]

# Descriptives at first observation
dt[first_cd == 1][order(chronic_disease_f)][, .(Women = .N), by = chronic_disease_f][, Cumsum := cumsum(Women)][
  , Percent := Women / max(Cumsum) * 100][]
```

```{r}
# Clean up
rm(ever_vars, time_invariant)
dt$first_cd <- NULL
```

```{r save_analysis_09}
# Save progress
analysis_09 <- as_tibble(dt)
write_rds(analysis_09, path = "../data/analysis_09.rds")
```

-------------------------------------------------------------------------------

&nbsp;

#### Session Info:

```{r session_info, echo=FALSE}
sessionInfo()
```
